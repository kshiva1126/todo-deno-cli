name: CI

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  quality-check:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x
        
    - name: Cache Deno dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/deno
        key: ${{ runner.os }}-deno-v2-${{ hashFiles('**/deno.json') }}
        restore-keys: |
          ${{ runner.os }}-deno-v2-
        
    - name: Verify formatting
      run: |
        echo "ğŸ¨ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        deno task fmt:check
        
    - name: Run linter
      run: |
        echo "ğŸ” ãƒªãƒ³ãƒˆãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        deno task lint
        
    - name: Type check
      run: |
        echo "ğŸ“ å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        deno task check

  test:
    name: Test on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        deno-version: [v2.x]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: ${{ matrix.deno-version }}
        
    - name: Cache Deno dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/deno
        key: ${{ runner.os }}-deno-v2-${{ hashFiles('**/deno.json') }}
        restore-keys: |
          ${{ runner.os }}-deno-v2-
        
    - name: Run tests
      run: |
        echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        deno task test
        
    - name: Test CLI installation and basic functionality
      run: |
        echo "âš™ï¸ CLIã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
        deno task install
        
        # Test basic commands
        echo "ğŸ“‹ åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ..."
        todo help
        
        echo "â• ã‚¿ã‚¹ã‚¯è¿½åŠ ãƒ†ã‚¹ãƒˆ..."
        todo add "CI ãƒ†ã‚¹ãƒˆã‚¿ã‚¹ã‚¯"
        
        echo "ğŸ“ ã‚¿ã‚¹ã‚¯ä¸€è¦§è¡¨ç¤ºãƒ†ã‚¹ãƒˆ..."
        todo list
        
        echo "âœ… ã‚¿ã‚¹ã‚¯å®Œäº†ãƒ†ã‚¹ãƒˆ..."
        todo complete 1
        todo list
        
        echo "ğŸ—‘ï¸ ã‚¿ã‚¹ã‚¯å‰Šé™¤ãƒ†ã‚¹ãƒˆ..."
        todo delete 1
        todo list
        
        echo "âœ¨ å…¨ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼"

  security-check:
    name: Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Deno
      uses: denoland/setup-deno@v1
      with:
        deno-version: v2.x
        
    - name: Run security audit
      run: |
        echo "ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œä¸­..."
        # Denoã®ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
        deno info --json main.ts | jq '.modules[] | select(.specifier | startswith("https://")) | .specifier' || true
        
        # æ¨©é™ãƒã‚§ãƒƒã‚¯
        echo "ğŸ“‹ å¿…è¦ãªæ¨©é™:"
        echo "  - --allow-read: ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿å–ã‚Š"
        echo "  - --allow-write: ã‚¿ã‚¹ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«ã®æ›¸ãè¾¼ã¿"
        echo "  - --allow-env: ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å–å¾—" 